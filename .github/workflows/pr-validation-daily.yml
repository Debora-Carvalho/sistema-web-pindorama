name: Pull Request Validation

# Pipeline executada quando um Pull Request for aberto/atualizado
# ExecuÃ§Ã£o diÃ¡ria Ã s 07:00 para gerar relatÃ³rio de atualizaÃ§Ã£o do projeto
on:
  pull_request:
    branches:
      - develop

  schedule:
    - cron: "0 7 * * *"   # todos os dias Ã s 07h (UTC â†’ 04h no Brasil)

defaults:
  run:
    shell: bash

jobs:

  ###############################
  #  JOB 1 â€” ValidaÃ§Ã£o do PR   #
  ###############################
  test-build:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest

    steps:
      - name: Initial
        run: |
          echo "---------------------------------------------"
          echo "ðŸš€ Iniciando processo de validaÃ§Ã£o do pull request com destino Ã  develop..."
          echo "Data e hora de inÃ­cio: $(date +"%d/%m/%Y Ã s %Hh%Mmin%Ss")"
          echo "---------------------------------------------"

      # baixa o cÃ³digo
      - name: Checkout repository
        uses: actions/checkout@v4

      # configura Node
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: npm

      # instala dependÃªncias
      - name: Install dependencies
        run: npm ci

      # faz build
      - name: Build test
        run: npm run build

      # checando backend
      - name: Check backend connection
        env:
          VITE_API_URL: ${{ secrets.VITE_API_URL }}
        run: |
          echo "Checking backend availability at $VITE_API_URL"
          curl -f "$VITE_API_URL" || (echo "âŒ API nÃ£o disponÃ­vel no momento" && exit 1)

      - name: Validation Summary
        if: success()
        run: |
          echo "---------------------------------------------"
          echo "âœ… Pull Request validado com sucesso!"
          echo "Branch: develop"
          echo "Data e hora: $(date +"%d/%m/%Y Ã s %Hh%Mmin%Ss")"
          echo "ðŸš€ Pronto para merge na main!"
          echo "---------------------------------------------"

      - name: Error handler
        if: failure()
        run: |
          echo "---------------------------------------------"
          echo "âŒ Falha na validaÃ§Ã£o do Pull Request!"
          echo "Branch: develop"
          echo "Data e hora: $(date +"%d/%m/%Y Ã s %Hh%Mmin%Ss")"
          echo "---------------------------------------------"


  ##########################################
  #  JOB 2 â€” ExecuÃ§Ã£o diÃ¡ria (relatÃ³rio)   #
  ##########################################
  daily-report:
    if: github.event_name == 'schedule'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate daily report
        run: |
          echo "=== RelatÃ³rio DiÃ¡rio - $(date +"%d/%m/%Y %H:%M") ===" >> daily-report.txt
          
          echo "Branch atual:" >> daily-report.txt
          git rev-parse --abbrev-ref HEAD >> daily-report.txt
          
          echo "" >> daily-report.txt
          echo "Ãšltimos arquivos modificados nas Ãºltimas 24h:" >> daily-report.txt
          git log --since="1 day ago" --name-only --pretty=format:"Autor: %an (%ae)" >> daily-report.txt

          echo "------------------------------" >> daily-report.txt
          echo "" >> daily-report.txt

      - name: Upload daily report artifact
        uses: actions/upload-artifact@v4
        with:
          name: daily-report
          path: daily-report.txt
